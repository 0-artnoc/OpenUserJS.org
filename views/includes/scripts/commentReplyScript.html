<script type="text/javascript">
  (function () {
    $('#reply-control').on('show.bs.collapse', function () {
      // Show spacer div
      $('#show-reply-form-when-visible').css({
        height: '{{#paginationRendered}}210{{/paginationRendered}}{{^paginationRendered}}268{{/paginationRendered}}px'
      });
    });

    $('#reply-control').on('hide.bs.collapse', function () {
      // Hide spacer div
      $('#show-reply-form-when-visible').css({
        height: '0'
      });

      // Clear text value from reply box
      $('#reply-control textarea[name="comment-content"]').val('');
    });

    $('.btn-comment-reply').click(function (aE) {
      $('#reply-control').collapse('show');

      var $comment = $(aE.target).closest('.topic-post');
      var $author = $comment.find('.topic-meta-data .names .username').first();
      var $replyTextarea = $('#reply-control textarea[name="comment-content"]');

      document.location.hash = $comment.attr('id');

      var value = $replyTextarea.val();
      if (!/^\s*$/.test(value)) {
        value += '\n\n'; // Add linebreaks if reply already started.
      }
      value += '[Re](' + document.location.href.replace(/\(/g, '%28').replace(/\)/g, '%29') + '): ';
      value += '[@' + $author.text() + '](' + $author.attr('href') + '): ';
      value += '  \n';
      $replyTextarea.val(value);
      $replyTextarea.focus();
    });

    function isElementInViewport(aEl) {
      if (aEl instanceof jQuery) {
        aEl = aEl[0];
      }

      var rect = aEl.getBoundingClientRect();

      return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */
        rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */
      );
    }

    var hasShownReplyForm = false;
    function callback(aEl) {
      if (!hasShownReplyForm) {
        $('#reply-control').collapse('show');
        hasShownReplyForm = true;

        $('#reply-control textarea[name="comment-content"]').focus();
      }
    }

    function fireIfElementVisible(aEl, aCallback) {
      return function () {
        if (isElementInViewport(aEl)) {
          aCallback(aEl);
        }
      }
    }

    var handler = fireIfElementVisible($('#show-reply-form-when-visible'), callback);

    // jQuery
    $(window).on('focus resize scroll', handler);

  })();
</script>
